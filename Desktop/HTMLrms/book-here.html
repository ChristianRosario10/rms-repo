<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rod Machine Shop - Book Here</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics-compat.js"></script>
    <style>
        .error-message {
            color: red;
            margin-top: 5px;
            font-size: 0.9em;
        }
        .progress {
            display: none;
            margin-top: 10px;
        }
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container d-flex justify-content-center">
        <div class="card p-4 shadow-lg" style="max-width: 600px; width: 100%; margin-top: 30px; background-color: #f8f9fa;">
            <h1 class="text-center mb-3">Machine Shop Work Request Form</h1>
            <hr>

            <!-- Error Message Container -->
            <div id="errorMessage" class="alert alert-danger text-center mb-3" role="alert" style="display: none;"></div>

            <form id="workRequestForm" action="#" method="POST">
                <!-- Customer Name -->
                <div class="mb-3">
                    <label class="form-label fw-bold" for="customerName">
                        Customer Name:
                    </label>
                    <input type="text" id="customerName" name="customerName" class="form-control" required>
                </div>

                <!-- Contact Number -->
                <div class="mb-3">
                    <label class="form-label fw-bold" for="contactNumber">
                        Contact Number: <small class="text-muted">(11 digits required)</small>
                    </label>
                    <input type="tel" id="contactNumber" name="contactNumber" class="form-control" required pattern="\d{11}" maxlength="11" placeholder="Enter 11-digit phone number">
                    <small id="phoneError" class="text-danger" style="display: none;">
                        Phone number must be exactly 11 digits.
                    </small>
                </div>

                <!-- Part Description -->
                <div class="mb-3">
                    <label class="form-label fw-bold" for="partDescription">
                        Part Description:
                    </label>
                    <textarea id="partDescription" name="partDescription" class="form-control" required rows="3"></textarea>
                </div>

                <!-- Material Type -->
                <div class="mb-3">
                    <label class="form-label fw-bold" for="materialType">
                        Material Type:
                    </label>
                    <select id="materialType" name="materialType" class="form-select" required>
                        <option value="">Select Material</option>
                        <option value="Aluminum">Aluminum</option>
                        <option value="Steel">Steel</option>
                        <option value="Brass">Brass</option>
                        <option value="Plastic">Plastic</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <!-- Quantity -->
                <div class="mb-3">
                    <label class="form-label fw-bold" for="quantity">
                        Quantity:
                    </label>
                    <input type="number" id="quantity" name="quantity" class="form-control" required min="1">
                </div>

                <!-- Due Date -->
                <div class="mb-3">
                    <label class="form-label fw-bold" for="dueDate">
                        Due Date:
                    </label>
                    <input type="date" id="dueDate" name="dueDate" class="form-control" required>
                </div>

                <!-- Upload Image -->
                <div class="mb-3">
                    <label class="form-label fw-bold" for="uploadImage">
                        Upload Image (Max 5MB):
                    </label>
                    <input type="file" id="uploadImage" name="uploadImage" class="form-control" accept="image/*">
                    <img id="imagePreview" class="image-preview mt-2" alt="Image Preview">
                    <div class="progress mt-2" style="display: none;">
                        <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn btn-success w-100" id="submitButton">
                    Submit Request
                </button>
            </form>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase Configuration -->
    <script>
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBFwa9t_axiROyS9HyEMBWYFrYs8vlGQ14",
            authDomain: "rod-machine-shop.firebaseapp.com",
            projectId: "rod-machine-shop",
            storageBucket: "rod-machine-shop.appspot.com",
            messagingSenderId: "634114192437",
            appId: "1:634114192437:web:7b4c61b2c5a7459152ed7c",
            measurementId: "G-Y7E0MVR6JZ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const analytics = firebase.analytics();
        const db = firebase.firestore();
        const storage = firebase.storage();

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('workRequestForm');
            const errorMessage = document.getElementById('errorMessage');
            const phoneInput = document.getElementById('contactNumber');
            const phoneError = document.getElementById('phoneError');
            const fileInput = document.getElementById('uploadImage');
            const imagePreview = document.getElementById('imagePreview');
            const progressBar = document.querySelector('.progress');
            const progressBarInner = document.querySelector('.progress-bar');

            // Image preview
            fileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        errorMessage.textContent = "Error: File size exceeds the maximum limit of 5MB.";
                        errorMessage.style.display = 'block';
                        this.value = '';
                        imagePreview.style.display = 'none';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                    errorMessage.style.display = 'none';
                }
            });

            // Phone number validation
            phoneInput.addEventListener('input', function() {
                const isValid = this.value.length === 11 && /^\d+$/.test(this.value);
                phoneError.style.display = isValid ? 'none' : 'block';
                if (this.value.length > 11) {
                    this.value = this.value.slice(0, 11);
                }
                phoneError.textContent = `Phone number must be exactly 11 digits. Currently: ${this.value.length} digits`;
            });

            // Form submission
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!form.checkValidity()) {
                    e.stopPropagation();
                    form.classList.add('was-validated');
                    return;
                }

                const submitButton = document.getElementById('submitButton');
                submitButton.disabled = true;
                submitButton.textContent = 'Submitting...';
                errorMessage.style.display = 'none';

                try {
                    let imageUrl = '';
                    const file = fileInput.files[0];
                    
                    if (file) {
                        const storageRef = storage.ref();
                        const fileRef = storageRef.child(`workRequests/${Date.now()}_${file.name}`);
                        
                        progressBar.style.display = 'block';
                        const uploadTask = fileRef.put(file);

                        await new Promise((resolve, reject) => {
                            uploadTask.on('state_changed',
                                (snapshot) => {
                                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                    progressBarInner.style.width = progress + '%';
                                },
                                (error) => reject(error),
                                async () => {
                                    imageUrl = await uploadTask.snapshot.ref.getDownloadURL();
                                    resolve();
                                }
                            );
                        });
                    }

                    const workRequest = {
                        customerName: document.getElementById('customerName').value,
                        contactNumber: document.getElementById('contactNumber').value,
                        partDescription: document.getElementById('partDescription').value,
                        materialType: document.getElementById('materialType').value,
                        quantity: parseInt(document.getElementById('quantity').value),
                        dueDate: document.getElementById('dueDate').value,
                        imageUrl: imageUrl,
                        status: 'Pending',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await db.collection('workRequests').add(workRequest);
                    
                    alert('Work request submitted successfully!');
                    form.reset();
                    fileInput.value = '';
                    imagePreview.style.display = 'none';
                    progressBar.style.display = 'none';
                } catch (error) {
                    console.error('Error:', error);
                    errorMessage.textContent = 'Error submitting work request. Please try again.';
                    errorMessage.style.display = 'block';
                } finally {
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit Request';
                }
            });
        });
    </script>
</body>
</html> 